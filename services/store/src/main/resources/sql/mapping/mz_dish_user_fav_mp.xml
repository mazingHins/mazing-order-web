<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 这里namespace必须是接口的路径，不然要运行的时候要报错 “is not known to the MapperRegistry” -->
<mapper namespace="com.mazing.services.store.mapping.dao.DishUserFavMpDao">

	<!-- 新增 -->
	<insert id="save" parameterType="com.mazing.services.store.mapping.entry.DishUserFavMpPO" useGeneratedKeys="false" >
		insert into mz_merchant.mz_dish_user_fav_mp (uid,dish_key,create_time) values (#{uid},#{dishKey},#{createTime})
	</insert>

	<!-- 删除指定的数据 -->
	<delete id="deleteById" parameterType="Map">
		DELETE FROM mz_merchant.mz_dish_user_fav_mp WHERE uid = #{uid} AND dish_key IN (
			<foreach collection="dishKeys" item="item" index="index" separator="," >#{item,jdbcType=BIGINT}</foreach>
		)
	</delete>

	<!-- 删除指定美食的收藏数据 -->
	<delete id="deleteByDishKey" parameterType="Map">
		DELETE FROM mz_merchant.mz_dish_user_fav_mp WHERE dish_key = #{dishKey}
	</delete>

	<!-- 根据主键读取记录（主键可能有多个） -->
	<select id="getById" parameterType="Map" resultType="com.mazing.services.store.mapping.entry.DishUserFavMpPO">
		SELECT * FROM mz_merchant.mz_dish_user_fav_mp WHERE dish_key = #{dishKey} AND uid=#{uid}
	</select>

	<!-- 获取某个美食全部的 用户收藏数据 -->
	<select id="queryDishFavs" parameterType="Map" resultType="com.mazing.services.store.mapping.entry.DishUserFavMpPO">
		SELECT * FROM mz_merchant.mz_dish_user_fav_mp where dish_key = #{dishKey}
	</select>

	<!-- 获取用户喜欢列表（分页|不分页） -->
	<select id="listMyFavByPage" parameterType="Map" resultType="com.mazing.services.store.mapping.entry.DishUserFavMpPO">
		SELECT * FROM mz_merchant.mz_dish_user_fav_mp where uid = #{uid} ORDER BY create_time DESC
		<if test="null != rows">
			LIMIT <if test="null != offset">#{offset},</if>#{rows}
		</if>
	</select>
	
	<!-- 获取在指定的美食key中，我喜欢的列表 -->
	<select id="listMyFav" parameterType="Map" resultType="com.mazing.services.store.mapping.entry.DishUserFavMpPO">
		SELECT * FROM mz_merchant.mz_dish_user_fav_mp where uid = #{uid} 
		AND dish_key IN (
		<foreach collection="dishKeys" item="item" index="index" separator="," >
			#{item}
		</foreach>
		) 
	</select>

	<!--
	美食收藏排行榜 2016/2/29 by ten
	-->
	<select id="statDishFavRank" resultType="Map">
		select
			a.dish_key as dishKey, a.dish_name as dishName, b.num
		from
		 	mz_merchant.mz_dish a
		inner join
			(select dish_key, count(*) num from mz_dish_user_fav_mp group by dish_key) b
		on
		 	a.dish_key=b.dish_key order by b.num desc limit 100;
	</select>
</mapper>
