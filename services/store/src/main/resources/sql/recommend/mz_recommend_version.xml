<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 这里namespace必须是接口的路径，不然要运行的时候要报错 “is not known to the MapperRegistry” -->
<mapper namespace="com.mazing.services.store.recommend.dao.RecommendVersionDao">

	<!-- 新增 -->
	<insert id="save" parameterType="com.mazing.services.store.recommend.entry.RecommendVersionPO" useGeneratedKeys="false">
		insert into mz_merchant.mz_recommend_version
		(vid,city_code,lang_code,status,create_time,modify_time,publish_time,rollback_time,admin_id,final_data)
		values
		(#{vid},#{cityCode},#{langCode},#{status},#{createTime},#{modifyTime},#{publishTime},#{rollbackTime},#{adminId},#{finalData})
	</insert>

	<!-- 更新 -->
	<update id="update" parameterType="com.mazing.services.store.recommend.entry.RecommendVersionPO">
		update mz_merchant.mz_recommend_version set status=#{status},modify_time=#{modifyTime},publish_time=#{publishTime},rollback_time=#{rollbackTime},admin_id=#{adminId},final_data=#{finalData} where vid=#{vid}
	</update>

	<!-- 根据主键读取记录（主键可能有多个） -->
	<select id="getById" parameterType="Map" resultType="com.mazing.services.store.recommend.entry.RecommendVersionPO">
		SELECT * FROM mz_merchant.mz_recommend_version WHERE vid=#{param1}
	</select>

	<!-- 查询某城市下指定语言的记录   查询 不是  历史版（也就是查询 测试版 + 正式版） -->
	<select id="listByCityLang" resultType="com.mazing.services.store.recommend.entry.RecommendVersionPO">
		SELECT * FROM mz_merchant.mz_recommend_version where city_code = #{cityCode} AND lang_code = #{langCode} AND status!=3 ORDER BY publish_time DESC, status ASC LIMIT #{offset}, #{limit}
	</select>

	<!-- 根据cityCode、langCode、status 获取 版本信息 -->
	<select id="listByCityLangStatus" parameterType="Map" resultType="com.mazing.services.store.recommend.entry.RecommendVersionPO">
		SELECT * FROM mz_merchant.mz_recommend_version where city_code=#{cityCode} AND lang_code=#{langCode} AND status=#{status} order by publish_time DESC
	</select>

	<!-- 修改 版本的状态、 修改时间、修改人信息 -->
	<update id="updateStatusAndModifyTimeById" parameterType="Map">
		update mz_merchant.mz_recommend_version
		set status=#{newStatus},modify_time=#{modifyTime},admin_id=#{adminId}
		<if test="2 == newStatus">,publish_time=#{modifyTime}</if>
		where vid=#{vid} AND status=#{oldStatus}
	</update>

	<!-- 获取最近的一条正式版历史记录(根据publish_time 倒排序) -->
	<select id="getLatestReleaseHistory" parameterType="Map" resultType="com.mazing.services.store.recommend.entry.RecommendVersionPO">
		SELECT * FROM mz_merchant.mz_recommend_version where city_code=#{cityCode} AND lang_code=#{langCode} AND status=4 order by publish_time DESC limit 1
	</select>

	<!-- 回滚版本 -->
	<update id="update2RollBackRecord" parameterType="Map">
		update mz_merchant.mz_recommend_version set status=#{newStatus},modify_time=now(),publish_time=now(),rollback_time=now(),admin_id=#{adminId} where vid=#{vid} AND status=#{oldStatus}
	</update>

</mapper>
