<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 这里namespace必须是接口的路径，不然要运行的时候要报错 “is not known to the MapperRegistry” -->
<mapper namespace="com.mazing.services.store.dish.dao.DishGroupMpDao">

	<!-- 新增 -->
	<insert id="save" parameterType="com.mazing.services.store.dish.entry.DishGroupMpPO" useGeneratedKeys="false" >
		insert into mz_merchant.mz_dish_group_mp (group_id,dish_key,sequence,store_id,create_time) values (#{groupId},#{dishKey},#{sequence},#{storeId},#{createTime})
	</insert>

	<!-- 根据主键，删除数据
	<delete id="deleteById" parameterType="Map">
		DELETE FROM mz_merchant.mz_dish_group_mp WHERE dish_key=#{param1} AND group_id=#{param2}
	</delete>
	 -->

	<!-- 更新 -->
	<update id="update" parameterType="com.mazing.services.store.dish.entry.DishGroupMpPO">
		update mz_merchant.mz_dish_group_mp set sequence=#{sequence},store_id=#{storeId} where dish_key=#{dishKey} and group_id=#{groupId}
	</update>

	<!-- 根据主键读取记录（主键可能有多个） -->
	<select id="getById" parameterType="Map" resultType="com.mazing.services.store.dish.entry.DishGroupMpPO">
		SELECT * FROM mz_merchant.mz_dish_group_mp WHERE dish_key=#{param1} AND group_id=#{param2}
	</select>

	<!-- 查询全部记录 -->
	<select id="listAll" resultType="com.mazing.services.store.dish.entry.DishGroupMpPO">
		SELECT * FROM mz_merchant.mz_dish_group_mp
	</select>
	
	<!-- 根据分组ID groupId, 删除该分组的信息 felix 2016-03-24 -->
	<delete id="deleteByGroupId" parameterType="Map">
		DELETE FROM mz_merchant.mz_dish_group_mp WHERE group_id=#{groupId}
	</delete>
	
	<!-- 查询门店下的美食分组关联记录  2016-03-24 add by hins -->
	<select id="listByStoreId" parameterType="Map" resultType="com.mazing.services.store.dish.entry.DishGroupMpPO">
		SELECT * FROM mz_merchant.mz_dish_group_mp WHERE store_id=#{storeId} order by sequence asc
	</select>
	
	<!-- 更新美食在分组内的排序, 将大于某个排序值的美食往下偏移一位 felix 2016-03-25 -->
	<update id="moveDownBySeq" parameterType="Map">
		UPDATE mz_merchant.mz_dish_group_mp SET sequence = sequence + 1 WHERE 
			group_id=#{groupId} 
			AND sequence>=#{sequence}
	</update>
	
	<!-- 根据美食key, 获取该美食所属的所有分组 felix 2016-03-25 -->
	<select id="listByDishKey" parameterType="Map" resultType="com.mazing.services.store.dish.entry.DishGroupMpPO">
		SELECT * FROM mz_merchant.mz_dish_group_mp WHERE dish_key=#{dishKey}
	</select>
	
	<!-- 根据dishkey 和 分组ID(可多个)删除关联信息  -->
	<delete id="deleteByGroupIdAndDishKey" parameterType="Map">
		DELETE FROM mz_merchant.mz_dish_group_mp WHERE group_id IN 
		(<foreach collection="groupIds" item="item" index="index" separator="," >
			#{item}
		</foreach>) AND dish_key=#{dishKey}
	</delete>
	
	<!-- 根据dishkey 删除关联信息  -->
	<delete id="deleteByDishKey" parameterType="Map">
		DELETE FROM mz_merchant.mz_dish_group_mp WHERE dish_key=#{dishKey}
	</delete>
	
	<!-- 将美食分组sequence的值在[start,end]区间-1 2016/03/25 add by hins -->
	<update id="addSequence" parameterType="Map">
		UPDATE mz_merchant.mz_dish_group_mp set sequence=sequence+1 where group_id=#{groupId} and sequence between #{start} and #{end}
	</update>
	
	<!-- 将美食分组sequence的值在[start,end]区间-1 2016/03/25 add by hins -->
	<update id="reduceSequence" parameterType="Map">
		UPDATE mz_merchant.mz_dish_group_mp set sequence=sequence-1 where group_id=#{groupId} and sequence between #{start} and #{end}
	</update>
	
	<!-- 修改美食分组关联sequence值 2016/03/25 add by hins -->
	<update id="updateSequence" parameterType="Map">
		UPDATE mz_merchant.mz_dish_group_mp set sequence=#{newSequence} where group_id=#{groupId} and dish_key=#{dishKey} and sequence=#{oldSequence}
	</update>
	
	<select id="getUpperMp"  parameterType="Map" resultType="com.mazing.services.store.dish.entry.DishGroupMpPO">
		SELECT * FROM mz_merchant.mz_dish_group_mp WHERE group_id=#{groupId}
			<![CDATA[ 
				AND sequence<#{seq}
			]]>
		ORDER BY sequence desc LIMIT 0,1
	</select>
	
	<select id="getLowerMp"  parameterType="Map" resultType="com.mazing.services.store.dish.entry.DishGroupMpPO">
		SELECT * FROM mz_merchant.mz_dish_group_mp WHERE group_id=#{groupId}
			<![CDATA[ 
				AND sequence>#{seq}
			]]>
		ORDER BY sequence asc LIMIT 0,1
	</select>
	
	<select id="statMaxSequenctByGroupId"  parameterType="Map" resultType="java.lang.Integer">
		SELECT IFNULL(MAX(sequence),0) FROM mz_merchant.mz_dish_group_mp WHERE group_id=#{groupId}
	</select>
	
	<select id="listByGroupId" parameterType="Map" resultType="com.mazing.services.store.dish.entry.DishGroupMpPO">
		SELECT * FROM mz_merchant.mz_dish_group_mp WHERE group_id=#{groupId} and store_id=#{storeId}
	</select>
	
	<update id="updateSequenceByBatch" parameterType="Map">
		UPDATE mz_merchant.mz_dish_group_mp
		<trim prefix="set" suffix="end">
		<trim prefix="sequence = case dish_key" suffix="">
			<foreach collection="list" item="i" index="index">
                   when #{i.dishKey} then #{i.sequence}
            </foreach>
        </trim>
		</trim>
		where group_id=#{groupId} and 
		<foreach collection="list" separator="or" item="i" index="index" >
              dish_key=#{i.dishKey}
        </foreach>
	</update>
	
</mapper>
