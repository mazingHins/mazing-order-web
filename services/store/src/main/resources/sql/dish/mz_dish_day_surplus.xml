<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 这里namespace必须是接口的路径，不然要运行的时候要报错 “is not known to the MapperRegistry” -->
<mapper namespace="com.mazing.services.store.dish.dao.DishDaySurplusDao">

	<!-- 根据序列值建立库存表 -->
	<update id="createTable" parameterType="Map">
		CREATE TABLE IF NOT
		EXISTS ${sourceTable}_${index} LIKE ${sourceTable}
	</update>

	<!-- 新增 -->
	<insert id="save" parameterType="Map" useGeneratedKeys="false">
		insert
		into ${tableName}
		(spec_key,store_id,dish_key,day,surplus,create_time)
		values
		(#{entity.specKey},#{entity.storeId},#{entity.dishKey},#{entity.day},#{entity.surplus},#{entity.createTime})
	</insert>

	<!-- 根据主键读取记录（主键可能有多个） -->
	<select id="getById" parameterType="Map"
		resultType="com.mazing.services.store.dish.entry.DishDaySurplusPO">
		SELECT * FROM ${tableName} WHERE day=#{day} AND
		spec_key=#{specKey}
	</select>

	<!-- 查询指定日期的菜品的所有规格库存数据列表 -->
	<select id="getByDishKey" parameterType="Map"
		resultType="com.mazing.services.store.dish.entry.DishDaySurplusPO">
		SELECT * FROM ${tableName} WHERE day=#{day} AND
		dish_key=#{dishKey}
	</select>
	
	<select id="pageAll" parameterType="Map"
		resultType="com.mazing.services.store.dish.entry.DishDaySurplusPO">
		SELECT * FROM ${tableName} LIMIT #{offset},#{pageSize}
	</select>
	
	
	
	<!-- 查询门店下 指定日期的所有菜品的库存数据列表 -->
	<select id="listByStoreId" parameterType="Map"
		resultType="com.mazing.services.store.dish.entry.DishDaySurplusPO">
		SELECT * FROM ${tableName} WHERE day=#{day} AND
		store_id=#{storeId}
	</select>


	<!-- 给指定的库存（菜品ID + day）减少库存 -->
	<update id="decSurplusAndIncSoldNum" parameterType="Map">
		update
		${tableName} set surplus = surplus - #{num}, sold_num = sold_num +
		#{num} where spec_key=#{specKey} and day=#{day} and surplus >= #{num}
	</update>

	<!-- 给指定的库存（菜品ID + day）增加库存 -->
	<update id="incSurplusAndDesSoldNum" parameterType="Map">
		update
		${tableName} set surplus = surplus + #{num}, sold_num = sold_num -
		#{num} where spec_key=#{specKey} and day=#{day}
	</update>

	<!-- 减少指定日期(如：明天)的库存数据(只改库存) add by sky -->
	<update id="decSurplusByDay" parameterType="Map">
		update ${tableName}
		set surplus = surplus - #{num} where spec_key=#{specKey} and
		day=#{day} and surplus >= #{num}
	</update>

	<!-- 增加指定日期(如：明天)的库存数据(只改库存) add by sky -->
	<update id="incSurplusByDay" parameterType="Map">
		update ${tableName}
		set surplus = surplus + #{num} where spec_key=#{specKey} and
		day=#{day}
	</update>

</mapper>
